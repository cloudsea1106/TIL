# ğŸ“Œë°ì´í„° ìˆ˜ì§‘, ì •ì œ, ì´ë¯¸ì§€ í¬ë¡¤ë§(ì…€ë ˆë‹ˆì›€)

í™”í›¼ìœ í†µì •ë³´ ë°ì´í„° ì‚¬ìš©

ê½ƒ í’ˆëª©ë³„(ìƒìœ„)/í’ˆì¢…ë³„(í•˜ìœ„) ë¶„ë¥˜, ë‚ ì§œë³„ íŒë§¤ëŸ‰ ì •ë¦¬

ì…€ë ˆë‹ˆì›€ì„ í™œìš©í•œ í’ˆì¢…ë³„ ì´ë¯¸ì§€ í¬ë¡¤ë§

-----------------------------------------

[TOC]



### âœ¨ë°ì´í„° ìˆ˜ì§‘ ë° ì •ì œ

- ë‚ ì§œë³„ í’ˆëª©, í’ˆì¢…, íŒë§¤ëŸ‰ ìˆ˜ì§‘
- [í™”í›¼ìœ í†µì •ë³´](https://flower.at.or.kr/api/apiOpenInfo.do) api key ë°œê¸‰
- MySQL

```bash
$ pip install requests dateutil pymysql
```

```python
# mysql_info.py

import requests
import datetime 
from dateutil.relativedelta import relativedelta
import pymysql

all_data = []

start_date = datetime.datetime.now() + relativedelta(days=-1)
target_date = start_date.strftime('%Y-%m-%d')  # 2022-10-01 í˜•ì‹

sales_url = f'https://flower.at.or.kr/api/returnData.api?kind=f001&serviceKey={apikey}&baseDate={target_date}&flowerGubn=1&dataType=json&countPerPage=10000'
sales_res = requests.get(sales_url).json()['response']['items']

results = dict()

for i in range(len(sales_res)):
    pumName = sales_res[i]['pumName']  # í’ˆëª©
    if pumName == 'ì ˆí™”':
        continue

    goodName = sales_res[i]['goodName']  # í’ˆì¢…
    goodName_index = goodName.find('(')
    if goodName_index != -1:
        goodName = goodName[:goodName_index]
        
    totQty = int(sales_res[i]['totQty'])  # íŒë§¤ëŸ‰

    all_data.append((pumName, goodName, totQty, target_date))

# print(all_data)


conn = pymysql.connect(host='{host}', port=3306, user='{username}', password='{password}', db='{dbname}', charset='utf8')
cur = conn.cursor()


# í’ˆëª© ì¤‘ë³µì œê±°
# ['ìœ¨ë§ˆ', 'ë³´ë¦¬', 'ì—í‚¤ë„¤ì‹œì•„', 'ì½”ì™€ë‹ˆ', ...]
subjects_data = []
for data in all_data:
    subject = data[0]
    if subject.find('(') == 0:
        subject = subject[1:-1]
    subjects_data.append(subject)
subjects = list(dict.fromkeys(subjects_data))

for flower in subjects:
    sql = "select exists (select * from subject where subject_name=%s)"
    vals = (flower)
    cur.execute(sql, vals)
    result = cur.fetchall()
    if result[0][0] == 0:
        sql = "insert into subject (flower_language, subject_name) values (%s, %s)"
        vals = ('', flower)
        cur.execute(sql, vals)
        conn.commit()
#         print(f'{target_date} ìƒˆë¡œ ë“±ë¡í•œ í’ˆëª©: {flower}')


# í’ˆëª©ë³„ í’ˆì¢… -> '', í’ˆì¢…í’ˆëª© ê°™ì€ í•­ëª© ì œì™¸
# [('ì¥ë¯¸', 'í”Œë¡œë ŒìŠ¤'), ('íŠœë¦½', 'ë§ê³ '), ('ì¥ë¯¸', 'ë¸”ë£¨ì ¤ë¦¬'), ...]
kinds_imsi_data = []
for data in all_data:
    subject = data[0]
    kind = data[1]
    kinds_imsi_data.append((subject, kind))
kinds = list(dict.fromkeys(kinds_imsi_data))

for (subject, kind) in kinds:
    sql1 = "select subject_id from subject where subject_name=%s"  # í’ˆëª©ëª…ì— í•´ë‹¹í•˜ëŠ” subject_id êµ¬í•˜ê¸°
    vals1 = (subject)
    cur.execute(sql1, vals1)
    result1 = cur.fetchall()[0][0]

    sql2 = "select exists (select * from kind where kind_name=%s and subject_id=%s)"  # í’ˆì¢…ëª…ê³¼ í’ˆëª©ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ê°€ ìˆëŠ”ì§€
    vals2 = (kind, result1)
    cur.execute(sql2, vals2)
    result2 = cur.fetchall()[0][0]

    # í’ˆëª©í’ˆì¢…ëª…ì´ ì„œë¡œ ë‹¤ë¥´ê³  ê¸°ì¡´ ë°ì´í„°ì— ì—†ë‹¤ë©´
    if (result2 == 0 and subject != kind):
        sql3 = "insert into kind (flower_image, kind_name, subject_id) values (%s, %s, %s)"
        vals3 = ('kind/default.jpg', kind, result1)
        cur.execute(sql3, vals3)
        conn.commit()
#         print(f'{target_date} ìƒˆë¡œ ë“±ë¡í•œ í’ˆì¢…: {subject}({result1}) {kind}')


# ë§¤ì¼ë§¤ì¼ í’ˆëª©ë³„ íŒë§¤ëŸ‰
# [(('êµ­í™”', '2022-09-05'), 36602), ...]
sales_imsi_data = dict()
for data in all_data:
    subject = data[0]
    sale_size = data[2]
    sale_date = data[3]
    if sales_imsi_data.get((subject, sale_date)) != None:
        sales_imsi_data[(subject, sale_date)] += sale_size
    else:
        sales_imsi_data[(subject, sale_date)] = sale_size
sales = list(sales_imsi_data.items())

for data in sales:
    subject = data[0][0]
    sale_date = data[0][1]
    sale_size = data[1]

    sql1 = "select subject_id from subject where subject_name=%s"  # í’ˆëª©ëª…ì— í•´ë‹¹í•˜ëŠ” subject_id êµ¬í•˜ê¸°
    vals1 = (subject)
    cur.execute(sql1, vals1)
    result1 = cur.fetchall()[0][0]

    sql2 = "select exists (select * from sale where sale_date=%s and subject_id=%s)"
    vals2 = (sale_date, result1)
    cur.execute(sql2, vals2)
    result2 = cur.fetchall()[0][0]

    if result2 == 0:
        sql3 = "insert into sale (sale_date, sale_size, subject_id) values (%s, %s, %s)"
        vals3 = (sale_date, sale_size, result1)
        cur.execute(sql3, vals3)
        conn.commit()
#         print(f'{target_date} ìƒˆë¡œ ë“±ë¡í•œ íŒë§¤ëŸ‰: {subject}({result1}) {sale_size}')


conn.close()
```

- Redis

```bash
$ pip install dateutil pymysql redis
```

```python
import datetime 
from dateutil.relativedelta import relativedelta
import pymysql
import redis

conn = pymysql.connect(host='{host}', port=3306, user='{username}', password='{password}', db='{dbname}', charset='utf8')
cur = conn.cursor()

yesterday_raw = datetime.datetime.now() + relativedelta(days=-1)
before_7days_raw = datetime.datetime.now() + relativedelta(days=-7)

yesterday = yesterday_raw.strftime('%Y-%m-%d')
before_7days = before_7days_raw.strftime('%Y-%m-%d')

sql = "select sum(sale_size) sale_size, subject_id from sale where DATE(sale_date) BETWEEN %s AND %s group by subject_id"
vals = (before_7days, yesterday)
cur.execute(sql, vals)
result = cur.fetchall()

subject_sales = dict()

if len(result) >= 1:
    for record in result:
        # print(record[0], record[1])  sum, id
        if int(record[0]) >= 10000:
            sale_point = 6

        elif int(record[0]) >= 5000:
            sale_point = 3
        
        elif int(record[0]) >= 1000:
            sale_point = 1

        else:
            sale_point = 0

        subject_sales[int(record[1])] = sale_point

    with redis.StrictRedis(host='{host}', port=6379, db=2, charset='utf-8', decode_responses=True, password='{password}') as connect:  # 2ë²ˆ db ì‚¬ìš©
        connect.hmset(yesterday, subject_sales)  # ì–´ì œë‚ ì§œ_í’ˆì¢…idë¥¼ keyë¡œ, í’ˆì¢…ë³„ íŒë§¤ëŸ‰ì„ valueë¡œ ì„¤ì •
        # print(connect.hgetall(yesterday))
        # print(f'{yesterday} íŒë§¤ëŸ‰ì— ë”°ë¥¸ ì ìˆ˜ redis ë“±ë¡')


conn.close()
```





### âœ¨ì´ë¯¸ì§€ í¬ë¡¤ë§ (ì…€ë ˆë‹ˆì›€)

- [ì°¸ê³  ì˜ìƒ](https://www.youtube.com/watch?v=1b7pXC1-IbE&t=1281s)
  - ê°€ìƒí™˜ê²½ `venv`ì—ì„œ í•´ë„ ë˜ê³ , ë¡œì»¬ì—ì„œ í•´ë„ ë¨
  - ê°€ìƒí™˜ê²½ì—ì„œ í•  ê²½ìš° íŒŒì¼ë“¤ì˜ ìœ„ì¹˜ë¥¼ ì˜®ê²¨ì•¼í•¨
- [ChromeDriver ì„¤ì¹˜](https://chromedriver.chromium.org/downloads)
  - `êµ¬ê¸€ ë„ì›€ë§ - Chrome ì •ë³´ `ì—ì„œ ë²„ì „ í™•ì¸, ìš´ì˜ì²´ì œì— ë§ëŠ” íŒŒì¼ ë‹¤ìš´
  - ì••ì¶• í•´ì œ í›„ `chromedriver.exe`íŒŒì¼ì„ ì…€ë ˆë‹ˆì›€ì„ ì‹¤í–‰í•  ê³³ì— ìœ„ì¹˜ì‹œí‚¤ê¸°
  - ê°™ì€ ìœ„ì¹˜ì— `images` í´ë” ë¯¸ë¦¬ ìƒì„±

```bash
$ pip install selenium
```

```python
from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.by import By
import time
import urllib.request
from mysql_info import kinds


for kind in kinds:

    if kind[0] == kind[1] or kind[1] == 'í˜¼í•©':
        continue

    options = webdriver.ChromeOptions()
    options.add_experimental_option("excludeSwitches", ["enable-logging"])
    driver = webdriver.Chrome(options=options)

    driver.get("https://www.google.co.kr/imghp?hl=ko&tab=ri&authuser=0&ogbl")
    elem = driver.find_element(By.NAME, "q")

    target_keyword = kind[0] + ' ' + kind[1]
    elem.send_keys(f"{target_keyword}")
    elem.send_keys(Keys.RETURN)
    try:  # ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆë‹¤ë©´
        driver.find_elements(By.CSS_SELECTOR, ".rg_i.Q4LuWd")[0].click()
        
        # ì´ë¯¸ì§€ê°€ ì™„ì „íˆ ë¡œë”©ë˜ê³ ë‚˜ì„œ ì´ë¯¸ì§€ì£¼ì†Œë¥¼ ë°›ì„ ìˆ˜ ìˆë„ë¡ ëŒ€ê¸°ì‹œê°„ ì„¤ì • (ì˜¤ë¥˜ë°©ì§€)
        # 3ì´ˆ ëŒ€ê¸°
        time.sleep(3)
        
        image_url = driver.find_element(By.CSS_SELECTOR, ".n3VNCb").get_attribute("src")
        urllib.request.urlretrieve(image_url, f"images/{target_keyword}.jpg")
        
        # ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë°›ê³ ë‚˜ì„œ ë‹¤ìŒ ë™ì‘ì„ ì‹¤í–‰í•˜ë„ë¡ ëŒ€ê¸°ì‹œê°„ ì„¤ì • (ì˜¤ë¥˜ë°©ì§€)
        time.sleep(3)
        
    except:  # ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ë‹¤ë©´
        pass
```

