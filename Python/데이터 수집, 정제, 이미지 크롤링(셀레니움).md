# ğŸ“Œë°ì´í„° ìˆ˜ì§‘, ì •ì œ, ì´ë¯¸ì§€ í¬ë¡¤ë§(ì…€ë ˆë‹ˆì›€)

í™”í›¼ìœ í†µì •ë³´ ë°ì´í„° ì‚¬ìš©

ê½ƒ í’ˆëª©ë³„(ìƒìœ„)/í’ˆì¢…ë³„(í•˜ìœ„) ë¶„ë¥˜, ë‚ ì§œë³„ íŒë§¤ëŸ‰ ì •ë¦¬

ì…€ë ˆë‹ˆì›€ì„ í™œìš©í•œ í’ˆì¢…ë³„ ì´ë¯¸ì§€ í¬ë¡¤ë§

-----------------------------------------

[TOC]



### âœ¨ë°ì´í„° ìˆ˜ì§‘

- ë‚ ì§œë³„ í’ˆëª©, í’ˆì¢…, íŒë§¤ëŸ‰ ìˆ˜ì§‘
- [í™”í›¼ìœ í†µì •ë³´](https://flower.at.or.kr/api/apiOpenInfo.do) api key ë°œê¸‰
- `tmp.py` íŒŒì¼ ìƒì„±,  `all_data.json` íŒŒì¼ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬, `all_data` ë³€ìˆ˜ì— í• ë‹¹ 

```bash
$ pip install dateutil
```

```python
import requests
import json
import datetime 
from dateutil.relativedelta import relativedelta

all_data = []

start_date = datetime.datetime.now() + relativedelta(days=-1)  # ì–´ì œ ë‚ ì§œ

while True:
    target_date = start_date.strftime('%Y-%m-%d')  # 2022-09-05 í˜•ì‹
    
    if target_date == '2018-12-31':  
        break

    sales_url = f'https://flower.at.or.kr/api/returnData.api?kind=f001&serviceKey={ë°œê¸‰ë°›ì€ api key}&baseDate={target_date}&flowerGubn=1&dataType=json&countPerPage=10000'
    sales_res = requests.get(sales_url).json()['response']['items']

    results = dict()

    for i in range(len(sales_res)):
        pumName = sales_res[i]['pumName']  # í’ˆëª©
        if pumName == 'ì ˆí™”':
            continue

        goodName = sales_res[i]['goodName']  # í’ˆì¢…
        goodName_index = goodName.find('(')
        if goodName_index != -1:
            goodName = goodName[:goodName_index]
            
        totQty = int(sales_res[i]['totQty'])  # íŒë§¤ëŸ‰

        all_data.append((pumName, goodName, totQty, target_date))

    start_date += relativedelta(days=-1)

with open('all_data.json', 'w', encoding='utf-8') as f:
    json.dump(all_data, f, ensure_ascii=False, indent=4)
```

```json
# all_data.json
[
    [
        "êµ­í™”",
        "ë°±ì„ ",
        3464,
        "2022-09-05"
    ],
    [
        "ê±°ë² ë¼",
        "ë¯¸ë‹ˆ",
        2841,
        "2022-09-05"
    ],
    [
        "êµ­í™”",
        "í¬ë“œ",
        2469,
        "2022-09-05"
    ],
    ...
]
```

```python
# tmp.py
all_data = [
    [
        "êµ­í™”",
        "ë°±ì„ ",
        3464,
        "2022-09-05"
    ],
    [
        "ê±°ë² ë¼",
        "ë¯¸ë‹ˆ",
        2841,
        "2022-09-05"
    ],
    [
        "êµ­í™”",
        "í¬ë“œ",
        2469,
        "2022-09-05"
    ],
    ...
]
```





### âœ¨ë°ì´í„° ì •ì œ

- í’ˆëª©, í’ˆì¢…, ì¼ì¼ íŒë§¤ëŸ‰

- `get_data.py` íŒŒì¼ ìƒì„±

```python
# get_data.py
from tmp import all_data


# 2022-09-06 ì˜¤í›„ 11ì‹œ 55ë¶„ ê¸°ì¤€


# í’ˆëª© ì¤‘ë³µì œê±° 276ê°œ
# ['ìœ¨ë§ˆ', 'ë³´ë¦¬', 'ì—í‚¤ë„¤ì‹œì•„', 'ì½”ì™€ë‹ˆ', ...]
subjects_data = []
for data in all_data:
    subject = data[0]
    subjects_data.append(subject)
subjects = list(set(subjects_data))
# print(len(subjects))


# í’ˆëª©ë³„ í’ˆì¢… 3486ê°œ
# [('ì¥ë¯¸', 'í”Œë¡œë ŒìŠ¤'), ('íŠœë¦½', 'ë§ê³ '), ('ì¥ë¯¸', 'ë¸”ë£¨ì ¤ë¦¬'), ...]
# í’ˆëª©ê³¼ í’ˆì¢…ì´ ê°™ê±°ë‚˜ í’ˆì¢…ì´ í˜¼í•©ì´ë©´ ë°ì´í„° ì…ë ¥í•  ë•Œ ì œì™¸í•  ì˜ˆì •
kinds_data = []
for data in all_data:
    subject = data[0]
    kind = data[1]
    kinds_data.append((subject, kind))
kinds = list(set(kinds_data))
# print(kinds)


# ë§¤ì¼ë§¤ì¼ í’ˆëª©ë³„ íŒë§¤ëŸ‰ 56990ê°œ
# [(('êµ­í™”', '2022-09-05'), 36602), ...]
sales_data = dict()
for data in all_data:
    subject = data[0]
    sale_size = data[2]
    sale_date = data[3]
    if sales_data.get((subject, sale_date)) != None:
        sales_data[(subject, sale_date)] += sale_size
    else:
        sales_data[(subject, sale_date)] = sale_size
sales = list(sales_data.items())
# print(sales)
```





### âœ¨ì´ë¯¸ì§€ í¬ë¡¤ë§ (ì…€ë ˆë‹ˆì›€)

- [ì°¸ê³  ì˜ìƒ](https://www.youtube.com/watch?v=1b7pXC1-IbE&t=1281s)
  - ê°€ìƒí™˜ê²½ `venv`ì—ì„œ í•´ë„ ë˜ê³ , ë¡œì»¬ì—ì„œ í•´ë„ ë¨
  - ê°€ìƒí™˜ê²½ì—ì„œ í•  ê²½ìš° íŒŒì¼ë“¤ì˜ ìœ„ì¹˜ë¥¼ ì˜®ê²¨ì•¼í•¨
- [ChromeDriver ì„¤ì¹˜](https://chromedriver.chromium.org/downloads)
  - `êµ¬ê¸€ ë„ì›€ë§ - Chrome ì •ë³´ `ì—ì„œ ë²„ì „ í™•ì¸, ìš´ì˜ì²´ì œì— ë§ëŠ” íŒŒì¼ ë‹¤ìš´
  - ì••ì¶• í•´ì œ í›„ `chromedriver.exe`íŒŒì¼ì„ ì…€ë ˆë‹ˆì›€ì„ ì‹¤í–‰í•  ê³³ì— ìœ„ì¹˜ì‹œí‚¤ê¸°
  - ê°™ì€ ìœ„ì¹˜ì— `images` í´ë” ë¯¸ë¦¬ ìƒì„±

```bash
$ pip install selenium
```

```python
from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.by import By
import time
import urllib.request
from get_data import kinds


for kind in kinds:

    if kind[0] == kind[1] or kind[1] == 'í˜¼í•©':
        continue

    options = webdriver.ChromeOptions()
    options.add_experimental_option("excludeSwitches", ["enable-logging"])
    driver = webdriver.Chrome(options=options)

    driver.get("https://www.google.co.kr/imghp?hl=ko&tab=ri&authuser=0&ogbl")
    elem = driver.find_element(By.NAME, "q")

    target_keyword = kind[0] + ' ' + kind[1]
    elem.send_keys(f"{target_keyword}")
    elem.send_keys(Keys.RETURN)
    try:  # ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆë‹¤ë©´
        driver.find_elements(By.CSS_SELECTOR, ".rg_i.Q4LuWd")[0].click()
        
        # ì´ë¯¸ì§€ê°€ ì™„ì „íˆ ë¡œë”©ë˜ê³ ë‚˜ì„œ ì´ë¯¸ì§€ì£¼ì†Œë¥¼ ë°›ì„ ìˆ˜ ìˆë„ë¡ ëŒ€ê¸°ì‹œê°„ ì„¤ì • (ì˜¤ë¥˜ë°©ì§€)
        # 3ì´ˆ ëŒ€ê¸°
        time.sleep(3)
        
        image_url = driver.find_element(By.CSS_SELECTOR, ".n3VNCb").get_attribute("src")
        urllib.request.urlretrieve(image_url, f"images/{target_keyword}.jpg")
        
        # ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë°›ê³ ë‚˜ì„œ ë‹¤ìŒ ë™ì‘ì„ ì‹¤í–‰í•˜ë„ë¡ ëŒ€ê¸°ì‹œê°„ ì„¤ì • (ì˜¤ë¥˜ë°©ì§€)
        time.sleep(3)
        
    except:  # ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ë‹¤ë©´
        pass
```

