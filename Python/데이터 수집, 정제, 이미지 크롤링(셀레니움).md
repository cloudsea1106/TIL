# 📌데이터 수집, 정제, 이미지 크롤링(셀레니움)

화훼유통정보 데이터 사용

꽃 품목별(상위)/품종별(하위) 분류, 날짜별 판매량 정리

셀레니움을 활용한 품종별 이미지 크롤링

-----------------------------------------

[TOC]



### ✨데이터 수집

- 날짜별 품목, 품종, 판매량 수집
- [화훼유통정보](https://flower.at.or.kr/api/apiOpenInfo.do) api key 발급
- `tmp.py` 파일 생성,  `all_data.json` 파일 내용을 그대로 복사, `all_data` 변수에 할당 

```bash
$ pip install dateutil
```

```python
import requests
import json
import datetime 
from dateutil.relativedelta import relativedelta

all_data = []

start_date = datetime.datetime.now() + relativedelta(days=-1)  # 어제 날짜

while True:
    target_date = start_date.strftime('%Y-%m-%d')  # 2022-09-05 형식
    
    if target_date == '2018-12-31':  
        break

    sales_url = f'https://flower.at.or.kr/api/returnData.api?kind=f001&serviceKey={발급받은 api key}&baseDate={target_date}&flowerGubn=1&dataType=json&countPerPage=10000'
    sales_res = requests.get(sales_url).json()['response']['items']

    results = dict()

    for i in range(len(sales_res)):
        pumName = sales_res[i]['pumName']  # 품목
        if pumName == '절화':
            continue

        goodName = sales_res[i]['goodName']  # 품종
        goodName_index = goodName.find('(')
        if goodName_index != -1:
            goodName = goodName[:goodName_index]
            
        totQty = int(sales_res[i]['totQty'])  # 판매량

        all_data.append((pumName, goodName, totQty, target_date))

    start_date += relativedelta(days=-1)

with open('all_data.json', 'w', encoding='utf-8') as f:
    json.dump(all_data, f, ensure_ascii=False, indent=4)
```

```json
# all_data.json
[
    [
        "국화",
        "백선",
        3464,
        "2022-09-05"
    ],
    [
        "거베라",
        "미니",
        2841,
        "2022-09-05"
    ],
    [
        "국화",
        "포드",
        2469,
        "2022-09-05"
    ],
    ...
]
```

```python
# tmp.py
all_data = [
    [
        "국화",
        "백선",
        3464,
        "2022-09-05"
    ],
    [
        "거베라",
        "미니",
        2841,
        "2022-09-05"
    ],
    [
        "국화",
        "포드",
        2469,
        "2022-09-05"
    ],
    ...
]
```





### ✨데이터 정제

- 품목, 품종, 일일 판매량

- `get_data.py` 파일 생성

```python
# get_data.py
from tmp import all_data


# 2022-09-06 오후 11시 55분 기준


# 품목 중복제거 276개
# ['율마', '보리', '에키네시아', '코와니', ...]
subjects_data = []
for data in all_data:
    subject = data[0]
    subjects_data.append(subject)
subjects = list(set(subjects_data))
# print(len(subjects))


# 품목별 품종 3486개
# [('장미', '플로렌스'), ('튜립', '망고'), ('장미', '블루젤리'), ...]
# 품목과 품종이 같거나 품종이 혼합이면 데이터 입력할 때 제외할 예정
kinds_data = []
for data in all_data:
    subject = data[0]
    kind = data[1]
    kinds_data.append((subject, kind))
kinds = list(set(kinds_data))
# print(kinds)


# 매일매일 품목별 판매량 56990개
# [(('국화', '2022-09-05'), 36602), ...]
sales_data = dict()
for data in all_data:
    subject = data[0]
    sale_size = data[2]
    sale_date = data[3]
    if sales_data.get((subject, sale_date)) != None:
        sales_data[(subject, sale_date)] += sale_size
    else:
        sales_data[(subject, sale_date)] = sale_size
sales = list(sales_data.items())
# print(sales)
```





### ✨이미지 크롤링 (셀레니움)

- [참고 영상](https://www.youtube.com/watch?v=1b7pXC1-IbE&t=1281s)
  - 가상환경 `venv`에서 해도 되고, 로컬에서 해도 됨
  - 가상환경에서 할 경우 파일들의 위치를 옮겨야함
- [ChromeDriver 설치](https://chromedriver.chromium.org/downloads)
  - `구글 도움말 - Chrome 정보 `에서 버전 확인, 운영체제에 맞는 파일 다운
  - 압축 해제 후 `chromedriver.exe`파일을 셀레니움을 실행할 곳에 위치시키기
  - 같은 위치에 `images` 폴더 미리 생성

```bash
$ pip install selenium
```

```python
from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.by import By
import time
import urllib.request
from get_data import kinds


for kind in kinds:

    if kind[0] == kind[1] or kind[1] == '혼합':
        continue

    options = webdriver.ChromeOptions()
    options.add_experimental_option("excludeSwitches", ["enable-logging"])
    driver = webdriver.Chrome(options=options)

    driver.get("https://www.google.co.kr/imghp?hl=ko&tab=ri&authuser=0&ogbl")
    elem = driver.find_element(By.NAME, "q")

    target_keyword = kind[0] + ' ' + kind[1]
    elem.send_keys(f"{target_keyword}")
    elem.send_keys(Keys.RETURN)
    try:  # 검색 결과가 있다면
        driver.find_elements(By.CSS_SELECTOR, ".rg_i.Q4LuWd")[0].click()
        
        # 이미지가 완전히 로딩되고나서 이미지주소를 받을 수 있도록 대기시간 설정 (오류방지)
        # 3초 대기
        time.sleep(3)
        
        image_url = driver.find_element(By.CSS_SELECTOR, ".n3VNCb").get_attribute("src")
        urllib.request.urlretrieve(image_url, f"images/{target_keyword}.jpg")
        
        # 이미지를 다운받고나서 다음 동작을 실행하도록 대기시간 설정 (오류방지)
        time.sleep(3)
        
    except:  # 검색 결과가 없다면
        pass
```

